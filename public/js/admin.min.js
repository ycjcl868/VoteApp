$(function(){
    // 上传照片
    $('#uploadImg').change(function(){
        uploadAjax('uploadImg','/admin/upload',function(res){
            console.log(typeof res);
            if(res.status == 1){
                $('#movieImg').val('/upload/'+res.filename);
                $('#movieImg_preview').attr('src','/upload/'+res.filename);
                return;
            }else{
                layer.open({content:'上传失败'});
                return;
            }
        });
    });


    // 添加电影
    $('#add-movie').click(function(){
        var params = {};
        params.cineName = $('#cineName').val();
        params.url = $('#movieImg').val();
        params.type = $('#type').val();
        params.des = $('#des').val();
        
        console.log(params);

        $.post('/admin/movie/add',params,function(result){
            // console.log(typeof result);
            var res = JSON.parse(result);
            // alert(res.statue > 0);
            if(res.statue > 0){
                // alert(1);
                layer.open({content:"上传成功"});
                location.reload();
            }
        });
    });


    // 删除电影
    $('.Sdel').click(function () {
        var cineId = $(this).siblings('input').val();
        var params = {};
        
        params.cineId = cineId;

        console.log(params);
        
        if(window.confirm("确定要删除")){

            $.post('/admin/movie/del',params,function (result) {
                var res = JSON.parse(result);
                if(res.statue > 0){
                    layer.open({content:'删除成功',time:3});
                    setTimeout(function () {
                        location.reload();
                    },3000);
                }else{
                    layer.open({content:"删除失败",time:3});
                }
            });
        }
    });





    /**
     *
     * @param input[file]的id
     * @param 上传的地址
     * @param 回调
     */
    function uploadAjax(target,url,fun) {
        if(window.FormData){
            var formData = new FormData();
            formData.append('upload',document.getElementById(target).files[0]);
            var xhr = new XMLHttpRequest();
            xhr.open('post',url);
            layer.open({
                type: 2,
                content: '上传中...',
                shadeClose:false
            });

            xhr.onload = function(){
                if(xhr.status === 200){
                    layer.closeAll();
                    var data = JSON.parse(xhr.responseText);
                    fun(data);
                }else{
                    alert('出错了');
                }
            };
            xhr.send(formData);
        }

    }




    $('#formData').submit(function(){
        $(this).preventDefault();
        return;
    });

    $('#propAdd').click(function () {
        $('#formData').resetForm();
    });







    //修改电影
    // $(".Ssave").bind("click",function(event){
		// event.preventDefault();
		// var params = {};
		// params.id = $(this).parent().siblings("th").html()
		// params.studentName = $(this).parent().siblings("td").eq(0).children("input").val();
		// $.post('/api/edit/student',params,function(result){
		// 	if(result.status == 1){
		// 		layer.open({content:result.info});
		// 		location.reload();
		// 		return;
		// 	}else{
		// 		layer.open({content:result.info});
		// 		return;
		// 	}
		// })
    // })	

});